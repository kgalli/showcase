#!/bin/bash

set -e

CODENAME="<%= codename %>"

apt-get update -qq
apt-get install -y curl apt-transport-https sudo
apt-get install -y postgresql postgresql-contrib redis-server

wget -qO - https://deb.pkgr.io/key | sudo apt-key add -

rm -f /etc/apt/sources.list.d/pkgr.list
echo "deb https://deb.pkgr.io/pkgr/gitlabhq ${CODENAME} pkgr" | sudo tee -a /etc/apt/sources.list.d/pkgr.list
sudo apt-get update -qq
sudo apt-get install -y gitlabhq

echo "CREATE USER \"user\" SUPERUSER PASSWORD 'pass';" | su - postgres -c psql && \
  echo "CREATE DATABASE gitlabhq;" | su - postgres -c psql && \
  echo "GRANT ALL PRIVILEGES ON DATABASE \"gitlabhq\" TO \"user\";" | su - postgres -c psql

HOSTNAME=$(curl -s http://169.254.169.254/latest/meta-data/public-hostname)

gitlabhq config:set DATABASE_URL=postgres://user:pass@127.0.0.1/gitlabhq
gitlabhq config:set REDIS_URL=redis://127.0.0.1:6379
gitlabhq config:set GITLAB_URL="http://${HOSTNAME}"

gitlabhq run rake gitlab:shell:install[v1.9.3]

cat >> /etc/ssh/sshd_config <<EOF

PermitUserEnvironment yes
EOF
service ssh reload

gitlabhq run rake db:schema:load db:seed_fu

gitlabhq scale web=1 worker=1


sudo apt-get install -y nginx

# setup nginx configuration
cat > /etc/nginx/sites-available/default <<EOF
server {
  listen          80;
  server_name     example.com;
  location / {
    proxy_pass      http://localhost:6000;
  }
}
EOF
 # restart nginx
sudo service nginx restart

echo "http://${HOSTNAME}"